{
  "pipelines": [
    {
      "name": "LLM Request Logs",
      "description": "Pipeline for processing LLM request logs with enrichment and routing",
      "filter": {
        "query": "service:llm-reliability-control-plane source:python"
      },
      "processors": [
        {
          "type": "attribute_remapper",
          "name": "Remap trace_id",
          "source": "dd.trace_id",
          "target": "trace_id",
          "preserve_source": false
        },
        {
          "type": "attribute_remapper",
          "name": "Remap span_id",
          "source": "dd.span_id",
          "target": "span_id",
          "preserve_source": false
        },
        {
          "type": "grok_parser",
          "name": "Parse LLM Request Metadata",
          "source": "metadata",
          "grok": {
            "support_rules": "",
            "match_rules": "llm_request %{DATA:endpoint} %{DATA:model} %{NUMBER:latency_ms:number} %{NUMBER:cost_usd:number}"
          }
        },
        {
          "type": "category_processor",
          "name": "Categorize Request Types",
          "target": "request_type",
          "categories": [
            {
              "name": "qa",
              "filter": {
                "query": "endpoint:qa"
              }
            },
            {
              "name": "reasoning",
              "filter": {
                "query": "endpoint:reason"
              }
            },
            {
              "name": "stress",
              "filter": {
                "query": "endpoint:stress"
              }
            }
          ]
        },
        {
          "type": "string_builder_processor",
          "name": "Enrich with Business Context",
          "template": "LLM Request: {{endpoint}} | Model: {{model}} | Cost: ${{cost_usd}} | Latency: {{latency_ms}}ms",
          "target": "business_context",
          "is_replace_missing": false
        },
        {
          "type": "url_parser",
          "name": "Parse Request URL",
          "source": "http.url",
          "target": "http_url_details",
          "normalize_ending_slashes": false
        },
        {
          "type": "user_agent_parser",
          "name": "Parse User Agent",
          "source": "http.useragent",
          "target": "http.useragent_details"
        }
      ]
    },
    {
      "name": "LLM Error Logs",
      "description": "Pipeline for processing LLM error logs with severity classification",
      "filter": {
        "query": "service:llm-reliability-control-plane status:error"
      },
      "processors": [
        {
          "type": "status_remapper",
          "name": "Map Error Status",
          "sources": ["status", "error.type", "error.message"]
        },
        {
          "type": "category_processor",
          "name": "Classify Error Severity",
          "target": "error_severity",
          "categories": [
            {
              "name": "critical",
              "filter": {
                "query": "error.type:AuthenticationException OR error.type:RateLimitException"
              }
            },
            {
              "name": "high",
              "filter": {
                "query": "error.type:TimeoutException OR error.type:ConnectionException"
              }
            },
            {
              "name": "medium",
              "filter": {
                "query": "error.type:ValidationException"
              }
            },
            {
              "name": "low",
              "filter": {
                "query": "*"
              }
            }
          ]
        },
        {
          "type": "message_remapper",
          "name": "Remap Error Message",
          "sources": ["error.message", "message"]
        }
      ]
    },
    {
      "name": "LLM Cost Logs",
      "description": "Pipeline for processing cost-related logs with alerting",
      "filter": {
        "query": "service:llm-reliability-control-plane cost_usd:*"
      },
      "processors": [
        {
          "type": "arithmetic_processor",
          "name": "Calculate Cost Per Token",
          "expression": "{{cost_usd}} / ({{input_tokens}} + {{output_tokens}})",
          "target": "cost_per_token",
          "is_replace_missing": true
        },
        {
          "type": "date_remapper",
          "name": "Parse Timestamp",
          "sources": ["timestamp", "date"]
        },
        {
          "type": "trace_id_remapper",
          "name": "Remap Trace ID",
          "sources": ["trace_id", "dd.trace_id"]
        }
      ]
    },
    {
      "name": "LLM Security Logs",
      "description": "Pipeline for processing security-related logs with redaction",
      "filter": {
        "query": "service:llm-reliability-control-plane security:* OR safety_block:true"
      },
      "processors": [
        {
          "type": "string_builder_processor",
          "name": "Redact Sensitive Prompt Data",
          "template": "[REDACTED]",
          "target": "prompt",
          "is_replace_missing": false
        },
        {
          "type": "category_processor",
          "name": "Classify Security Event Type",
          "target": "security_event_type",
          "categories": [
            {
              "name": "prompt_injection",
              "filter": {
                "query": "security:prompt_injection_risk"
              }
            },
            {
              "name": "token_abuse",
              "filter": {
                "query": "security:token_abuse"
              }
            },
            {
              "name": "safety_block",
              "filter": {
                "query": "safety_block:true"
              }
            }
          ]
        }
      ]
    }
  ],
  "archive_configs": [
    {
      "name": "LLM Logs Archive",
      "query": "service:llm-reliability-control-plane",
      "retention_days": 30,
      "rehydrate": true,
      "rehydration_tags": ["rehydrated:true", "archive:llm"]
    },
    {
      "name": "LLM Error Logs Archive",
      "query": "service:llm-reliability-control-plane status:error",
      "retention_days": 90,
      "rehydrate": true,
      "rehydration_tags": ["rehydrated:true", "archive:llm_errors"]
    }
  ],
  "note": "These log pipelines can be configured in Datadog Logs → Configuration → Pipelines. They provide enrichment, parsing, categorization, and archival for LLM application logs."
}

